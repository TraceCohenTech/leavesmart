<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Wake-Up Alarm - Real-Time Conditions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { color: #333; }
    form { background: #fff; padding: 20px; border-radius: 8px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 15px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
    button { margin-top: 20px; padding: 10px 15px; background: #007BFF; border: none; color: #fff; border-radius: 4px; cursor: pointer; }
    .result { margin-top: 20px; background: #e2f7e2; padding: 15px; border-radius: 8px; }
    .notification { margin-top: 10px; font-size: 0.9em; color: #555; }
    .loading { color: #007BFF; }
  </style>
</head>
<body>
  <h1>Smart Wake-Up Alarm with Real-Time Adjustments</h1>
  
  <form id="alarmForm">
    <!-- Arrival Time & Routine Duration -->
    <label for="arrivalTime">Desired Arrival Time (HH:MM, 24-hour format):</label>
    <input type="time" id="arrivalTime" required>

    <label for="routineDuration">Morning Routine Duration (minutes):</label>
    <input type="number" id="routineDuration" placeholder="e.g., 45" required>

    <!-- Destination Input -->
    <label for="destination">Destination Address:</label>
    <input type="text" id="destination" placeholder="Enter destination address" required>

    <!-- Preferred Transportation Method -->
    <label for="transport">Preferred Transportation:</label>
    <select id="transport" required>
      <option value="driving">Driving</option>
      <option value="transit">Public Transit</option>
      <option value="bicycling">Bicycling</option>
      <option value="walking">Walking</option>
    </select>

    <!-- Hidden field to show current location info -->
    <div id="locationInfo" style="margin-top:15px; font-style:italic;"></div>

    <button type="submit">Calculate Wake-Up Time</button>
  </form>

  <div id="result" class="result" style="display:none;"></div>
  
  <script>
    // Global variable to store current location coordinates
    let currentCoords = null;

    // Attempt to get the user's current location when the page loads
    window.onload = function() {
      const locationInfo = document.getElementById('locationInfo');
      if (navigator.geolocation) {
        locationInfo.innerHTML = 'Retrieving current location...';
        navigator.geolocation.getCurrentPosition(
          function(position) {
            currentCoords = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            };
            locationInfo.innerHTML = `Current location: (${currentCoords.latitude.toFixed(4)}, ${currentCoords.longitude.toFixed(4)})`;
          },
          function(error) {
            locationInfo.innerHTML = 'Unable to retrieve location. Please allow location access.';
          }
        );
      } else {
        locationInfo.innerHTML = 'Geolocation is not supported by your browser.';
      }
    };

    document.getElementById('alarmForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Validate that we have a current location
      if (!currentCoords) {
        alert('Current location not available. Please allow location access or try again.');
        return;
      }

      // Collect input values
      const arrivalTime = document.getElementById('arrivalTime').value;
      const routineDuration = parseInt(document.getElementById('routineDuration').value, 10);
      const destination = document.getElementById('destination').value;
      const transport = document.getElementById('transport').value;

      // Show a loading message while "fetching" data
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `<p class="loading">Calculating route and conditions, please wait...</p>`;

      // Simulate API calls to get travel time, weather delay, and traffic delay.
      // In a real application, these would be asynchronous API calls.
      setTimeout(function() {
        const travelTime = getSimulatedTravelTime(currentCoords, destination, transport); // in minutes
        const weatherDelay = getSimulatedWeatherDelay(); // in minutes
        const trafficDelay = getSimulatedTrafficDelay(transport); // in minutes

        // Buffer time: we add the travel time plus the worst-case delay, then add a little extra buffer
        const bufferTime = travelTime + Math.max(weatherDelay, trafficDelay) + 5; // extra 5 minutes as safety margin

        // Convert desired arrival time to minutes since midnight
        const [arrivalHours, arrivalMinutes] = arrivalTime.split(':').map(Number);
        const arrivalTotalMinutes = arrivalHours * 60 + arrivalMinutes;
        
        // Calculate wake-up time: arrival time minus routine duration and buffer time
        let wakeUpMinutes = arrivalTotalMinutes - routineDuration - bufferTime;
        if (wakeUpMinutes < 0) wakeUpMinutes += 24 * 60; // wrap around midnight
        
        const wakeUpHours = Math.floor(wakeUpMinutes / 60);
        const wakeUpRemainingMinutes = wakeUpMinutes % 60;
        const formattedWakeUpTime = `${String(wakeUpHours).padStart(2, '0')}:${String(wakeUpRemainingMinutes).padStart(2, '0')}`;

        // Prepare a detailed notification message
        const notification = `
          <strong>Travel Time:</strong> ${travelTime} minutes<br>
          <strong>Simulated Weather Delay:</strong> ${weatherDelay} minutes<br>
          <strong>Simulated Traffic Delay:</strong> ${trafficDelay} minutes<br>
          <strong>Total Buffer Time (travel + delays + safety margin):</strong> ${bufferTime} minutes<br>
          <br>
          <em>The wake-up time is calculated as:</em><br>
          Arrival Time - (Morning Routine Duration + Total Buffer Time)
        `;

        resultDiv.innerHTML = `<h2>Suggested Wake-Up Time: ${formattedWakeUpTime}</h2>
                               <div class="notification">${notification}</div>`;
      }, 1500); // simulate delay for API responses
    });

    // Simulated API function: Calculate travel time based on current location, destination, and transportation mode.
    function getSimulatedTravelTime(coords, destination, transport) {
      // In a real app, you would use a Directions API here.
      // For simulation, we generate a travel time based on random values and transportation type.
      // We assume:
      // - Driving: 10-30 minutes
      // - Public Transit: 15-40 minutes
      // - Bicycling: 10-25 minutes
      // - Walking: 20-60 minutes

      let minTime, maxTime;
      switch (transport) {
        case 'driving':
          minTime = 10; maxTime = 30;
          break;
        case 'transit':
          minTime = 15; maxTime = 40;
          break;
        case 'bicycling':
          minTime = 10; maxTime = 25;
          break;
        case 'walking':
          minTime = 20; maxTime = 60;
          break;
        default:
          minTime = 15; maxTime = 40;
      }
      return Math.floor(Math.random() * (maxTime - minTime + 1)) + minTime;
    }

    // Simulated function to return weather delay (e.g., based on current weather conditions)
    function getSimulatedWeatherDelay() {
      // In a real application, fetch weather conditions (rain, snow, etc.) using a Weather API.
      // Simulate delay between 0 and 10 minutes.
      return Math.floor(Math.random() * 11);
    }

    // Simulated function to return traffic delay based on transportation mode
    function getSimulatedTrafficDelay(transport) {
      // In a real application, use a Traffic API to get current congestion data.
      let baseDelay;
      switch (transport) {
        case 'driving': baseDelay = Math.floor(Math.random() * 21); break; // up to 20 minutes
        case 'transit': baseDelay = Math.floor(Math.random() * 16); break; // up to 15 minutes
        case 'bicycling': baseDelay = Math.floor(Math.random() * 11); break; // up to 10 minutes
        case 'walking': baseDelay = Math.floor(Math.random() * 6); break;  // up to 5 minutes
        default: baseDelay = 0;
      }
      return baseDelay;
    }
  </script>
</body>
</html>
